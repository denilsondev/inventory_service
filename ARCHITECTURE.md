# Arquitetura do Sistema

## Diagrama Detalhado

```
┌─────────────────────────────────────────────────────────────────┐
│                    🏪 Lojas Distribuídas                        │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   Loja 001  │  │   Loja 002  │  │   Loja N    │            │
│  │             │  │             │  │             │            │
│  │ • POS       │  │ • POS       │  │ • POS       │            │
│  │ • Sistema   │  │ • Sistema   │  │ • Sistema   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      │ HTTP Events
                      │ POST /v1/eventos/estoque-ajustado
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    🏢 API Central (NestJS)                      │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                EventosService                           │   │
│  │  • Idempotência (idEvento)                             │   │
│  │  • Controle de Versão (versao > atual)                 │   │
│  │  • Validação (estoque >= 0)                            │   │
│  │  • Gap Detection (versao > atual + 1)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Observabilidade                          │   │
│  │  • Health Check (/health)                               │   │
│  │  • Métricas Prometheus (/metrics)                       │   │
│  │  • Logs Estruturados                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      │ Prisma ORM
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    💾 SQLite Database                          │
│                                                                 │
│  ┌─────────────────────┐  ┌─────────────────────┐            │
│  │ InventarioPorLoja   │  │ EventoProcessado    │            │
│  │                     │  │                     │            │
│  │ • idLoja (PK)       │  │ • idEvento (PK)     │            │
│  │ • sku (PK)          │  │ • criadoEm          │            │
│  │ • quantidade        │  └─────────────────────┘            │
│  │ • versao            │                                     │
│  │ • atualizadoEm      │                                     │
│  └─────────────────────┘                                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    🔄 Simulador (Node.js)                      │
│                                                                 │
│  • 100 eventos de teste                                        │
│  • 70% vendas (-1) | 30% reposições (+5)                       │
│  • 10% gaps de versão                                          │
│  • Versões sequenciais por (loja, produto)                     │
└─────────────────────────────────────────────────────────────────┘
``` 